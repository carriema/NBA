<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <style>
        .domain {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
            font: 10px sans-serif;
        }
        .domain text {
            font: 10px sans-serif;
        }

        rect {
            fill-opacity: 0.2;
            transition: fill-opacity 250ms linear;
        }

        rect.active {
            fill-opacity: 1;
        }




        .brush .extent {
            stroke: #fff;
            fill-opacity:.123;
            shape-rendering: crispEdges;
        }


    </style>
</head>
<body>



</body>
<script>

    var margin = {left:30, right : 30, top:180, bottom: 100};
    var width = 900 + margin.left + margin.right,
            height = 600 + margin.top + margin.bottom;


    //Define map projection
    var projection = d3.geo.albersUsa()
            .translate([width/3, height/3.5])
            .scale([900]);


    //Define path generator
    var path = d3.geo.path()
            .projection(projection);

    //Map the winrate to opacity[0.3, 0.9]
    var Opacity = d3.scale.linear()
            .range([0.2, 0.9]);

    //Map the rank to radius[2, 20]
    var Scale = d3.scale.linear()
            .range([2, 20]);

    //Create SVG element
    var svg = d3.select("body")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .on("click", stopped, true);

    //Creater a group to store states
    var g = svg.append("g")
            .attr("class","map");



    //Load in state data, draw the map
    d3.csv("US-states.csv", function(data) {
        //Load in GeoJSON data
        d3.json("US-geo.json", function(json) {
            //Merge the EastorWest data and GeoJSON
            //Loop through once for each EastorWest data value
            for (var i = 0; i < data.length; i++) {
                var dataState = data[i].state;				//Grab state name
                var dataValue = parseFloat(data[i].value);	//Grab data value, and convert from string to float
                var dataEASTorWEST = data[i].EASTorWEST;
                //Find the corresponding state inside the GeoJSON
                for (var j = 0; j < json.features.length; j++) {
                    var jsonState = json.features[j].properties.name;
                    if (dataState == jsonState) {
                        //Copy the data value into the JSON
                        json.features[j].properties.EASTorWEST = dataEASTorWEST;
                        //Stop looking through the JSON
                        break;
                    }
                }
            }

            //Bind data and create one path per GeoJSON feature
            g.selectAll("path")
                    .data(json.features).enter()
                    .append("path")
                    .attr("stroke","white")
                    .attr("stroke-width",2)
                    .attr("d", path)
                    .attr("class", function(d) {
                        return d.properties.postal;})
                    .style("fill", function(d) {
                        //Get data value
                        var EASTorWEST = d.properties.EASTorWEST;

                        if (EASTorWEST) {
                            //If value exists…
                            if (EASTorWEST == "East") {
                                return "#C6E2FF";
                            } else {
                                return "#FFB6C1";
                            }
                        } else {
                            //If value is undefined…
                            return "#CCCCCC";
                        }
                    });
//                    .on("click", stateClick);
            //Load in NBA teams data
            d3.csv("NBA-teams.csv", function(data) {
                //Map the rank to radius[2, 20]
                Scale.domain([0, d3.max(data, function(d) { return d.winrate; })]);

                //Map the rank to opacity[0.3, 0.9]
                Opacity.domain([0, d3.max(data, function(d) { return d.winrate; })]);


                //Create nodes group
                var nodes = g.selectAll("nodes")
                        .data(data)
                        .enter()
                        .append("g")
                        .attr("class", "team")
                        .attr("transform", function(d) {
                            return "translate(" + projection([d.lon, d.lat])[0] + "," + projection([d.lon, d.lat])[1] + ")";});



                //Circles for teams
                nodes.append("circle")
                        .attr("class", function(d) { return d.abb })
                        .attr("r", 8)
                        .style("fill", function(d){
                            if (d.EASTorWEST == "East") {
                                return "blue";
                            } else {
                                return "red";
                            };
                        })
                        .style("opacity", 0.8)
                        .attr("stroke","white")
                        .attr("stroke-width",0.5);
//                        .style("cursor", "pointer")

                //Text for temm abbreviation
                nodes.append("text")
                        .attr("class", function(d) {
                            return "text " + d.abb;})
                        .attr("dx", function(d){
                            return Scale(d.winrate);})
                        .attr("dy", ".3em")
                        .attr("font-size", 13)
                        .style("fill", "#888888")
                        .style("font-weight", "bold")
                        .style("cursor", "default")
                        .text(function(d) {
                            return d.abb;});
            });
        });
    });
//change the position of the bar chart at end; Start to draw barChart/
    var bar = d3.select("svg").append("g").attr("transform","translate(" + margin.left + ", " + 500 + ")");
    var x=d3.scale.ordinal().rangeRoundBands([0,900],.2);;
    var y=d3.scale.linear() .range([200, 0]);
    var xAxis = d3.svg.axis().scale(x).tickValues(x.domain()).orient("bottom");
    //var yAxis = d3.svg.axis().scale(y).orient("left");


    d3.csv("data.csv", function(d){
        d.PLUS_MINUS = +d.PLUS_MINUS;
        var date = d.GAME_DATE.split("/");
        d.GAME_DATE = new Date(date[0], date[1],date[2]);
        return d}, function(error,data) {
            if (error) throw error;

        var key = "GSW";
        var value = d3.nest().key(function(d){return d.TEAM_ABBREVIATION}).entries(data);
        for (var i = 0; i < value.length; i++) {
            if (value[i].key == key) {
                value = value[i].values;
            }
        }
        //console.log("data");
        //console.log(value);
        x.domain(value.map(function(d){
            return d.GAME_DATE;
        }));
        y.domain(d3.extent(value, function(d1) { return d1.PLUS_MINUS; })).nice();

        var rectangle = bar.append("g").selectAll("rect")
                .data(value)
                .enter()
                .append("rect")
                .attr("x", function(d){return x(d.GAME_DATE)})
                .attr("y", function(d){return y(Math.max(0,d.PLUS_MINUS))})
                .attr("width", x.rangeBand())
                .attr("height", function(d) {return Math.abs(y(d.PLUS_MINUS) - y(0))})
                .style("fill", function(d){
                    if (d.PLUS_MINUS < 0) {
                        return "red";
                    } else {
                        return "green";
                    }
                });
        bar.append("g")
                .attr("class", "x axis")
                .style("stroke", "1px")
                .attr("transform", "translate(0," + y(0) + ")")
                .call(xAxis);


//        bar.append("g")
//                .attr("class", "y axis")
//                .call(yAxis);
        bar.append("g")
                .attr("class", "brush")
                .call(d3.svg.brush().x(x)
                        .on("brush", brushmove))
                .selectAll("rect")
                .attr("height", 200);

        function brushmove() {
            var s =d3.event.target.extent();
            if (s == null) {
                rectangle.classed("active", false);
            } else {
                rectangle.classed("active", function(d) { return s[0] <= x(d.GAME_DATE) && x(d.GAME_DATE) <= s[1];});
            }
        }
//        function brushstart() {
//            bar.classed("selecting", true);
//        }
//
//        function brushmove() {
//            var s = d3.event.target.extent();
//            console.log(s);
//            rectangle.classed("selected", function(d) { console.log(s[0] <= x(d.GAME_DATE) && x(d.GAME_DATE) <= s[1]); return s[0] <= x(d.GAME_DATE) && x(d.GAME_DATE) <= s[1]; });
//        }
//        function brushend() {
//            bar.classed("selecting", !d3.event.target.empty());
//        }
//

    });
    function stopped() {
        if (d3.event.defaultPrevented) {
            d3.event.stopPropagation();
        }
    }
</script>
</html>